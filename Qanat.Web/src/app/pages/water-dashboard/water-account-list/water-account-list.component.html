@if (currentUser$ | async) {
    @if (geography$ | async; as geography) {
        <water-dashboard-nav [geography]="geography" (waterAccountCreated)="onWaterAccountCreated()"> </water-dashboard-nav>
        <div class="full-width-page">
            <page-header
                preTitle="Water Dashboard"
                pageTitle="Water Accounts"
                [customRichTextTypeID]="richTextID"
                icon="WaterAccounts"
                [templateBottomRight]="templateBottomRight"></page-header>
            <ng-template #templateBottomRight>
                <button routerLink="/water-accounts/request-changes" class="btn btn-orange request-changes-button" [disabled]="isLoading || currentUserHasNoGeographies">
                    Request Water Account Changes
                </button>
            </ng-template>
            @if (currentUserGeographies$ | async; as currentUserGeographies) {
                <div class="page-body" [loadingSpinner]="{ isLoading: isLoading && firstLoad, loadingHeight: 700 }">
                    <app-alert-display></app-alert-display>
                    @if (!currentUserHasNoGeographies) {
                        @if (waterAccounts$ | async; as waterAccounts) {
                            <hybrid-map-grid
                                [rowData]="waterAccounts"
                                [columnDefs]="columnDefs$ | async"
                                downloadFileName="water-accounts"
                                entityIDField="WaterAccountID"
                                (gridReady)="onGridReady($event)"
                                (onMapLoad)="handleMapReady($event)"
                                [selectedValue]="selectedWaterAccountID"
                                (selectedValueChange)="onSelectedWaterAccountIDChanged($event)">
                                <div headerActions>
                                    <div class="form-field" class="geography-selector">
                                        <div class="field">
                                            <ng-select
                                                name="Geography"
                                                [(ngModel)]="currentGeography"
                                                (ngModelChange)="onGeographySelected($event)"
                                                [compareWith]="compareGeography"
                                                [items]="currentUserGeographies"
                                                [clearable]="false"
                                                [searchable]="false"
                                                bindLabel="GeographyName"
                                                class="custom small">
                                            </ng-select>
                                        </div>
                                    </div>
                                </div>
                                @if (mapIsReady) {
                                    <div mapLayers [loadingSpinner]="{ isLoading: layerLoading, opacity: 0.33 }">
                                        @if (waterAccountIDs$ | async; as waterAccountIDs) {
                                            @if (wells$ | async; as wells) {
                                                <water-accounts-layer
                                                    [geographyID]="geography.GeographyID"
                                                    [selectedWaterAccountID]="selectedWaterAccountID"
                                                    [waterAccountIDs]="currentUserHasOverallPermission ? null : waterAccountIDs"
                                                    [wells]="wells"
                                                    [map]="map"
                                                    [layerControl]="layerControl"
                                                    (layerBoundsCalculated)="handleLayerBoundsCalculated($event)"
                                                    (waterAccountSelected)="onSelectedWaterAccountIDChanged($event)"
                                                    (layerStartedLoading)="onLayerLoadStarted()"
                                                    (layerFinishedLoading)="onLayerLoadFinished()">
                                                </water-accounts-layer>
                                            }
                                        }
                                        @if (geography) {
                                            <gsa-boundaries [displayOnLoad]="false" [map]="map" [geographyID]="geography.GeographyID" [layerControl]="layerControl">
                                            </gsa-boundaries>
                                        }
                                        @for (zoneGroup of zoneGroups$ | async; track zoneGroup) {
                                            <zone-group-layer
                                                [displayOnLoad]="false"
                                                [zoneGroupID]="zoneGroup.ZoneGroupID"
                                                [zoneGroupName]="zoneGroup.ZoneGroupName"
                                                [map]="map"
                                                [layerControl]="layerControl">
                                            </zone-group-layer>
                                        }
                                        @for (externalMapLayer of externalMapLayers$ | async; track externalMapLayer) {
                                            <geography-external-map-layer [map]="map" [layerControl]="layerControl" [externalMapLayer]="externalMapLayer">
                                            </geography-external-map-layer>
                                        }
                                    </div>
                                }
                            </hybrid-map-grid>
                        }
                    } @else {
                        <div class="alert alert-info">
                            <div class="alert-content">
                                <i class="fa fa-info"></i>
                                Your user profile does not currently have access to any Water Accounts. Claim Water Accounts to get started or contact a water manager for your
                                geography for assistance.
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    }
}
