@if (geography$ | async; as geography) {
    @if (currentUser$ | async) {
        <water-dashboard-nav [geography]="geography"></water-dashboard-nav>
        <div class="full-width-page">
            <page-header [customRichTextTypeID]="richTextID" icon="Parcels" pageTitle="Parcels" preTitle="Water Dashboard"></page-header>
            @if (currentUserGeographies$ | async; as currentUserGeographies) {
                <div class="page-body" [loadingSpinner]="{ isLoading: isLoading && firstLoad, loadingHeight: 700 }">
                    <app-alert-display></app-alert-display>
                    @if (!currentUserHasNoGeographies) {
                        @if (reportingPeriods$ | async; as reportingPeriods) {
                            @if (parcels$ | async; as parcels) {
                                <hybrid-map-grid
                                    [rowData]="parcels"
                                    [columnDefs]="columnDefs$ | async"
                                    downloadFileName="parcels"
                                    entityIDField="ParcelID"
                                    (gridReady)="onGridReady($event)"
                                    (onMapLoad)="handleMapReady($event)"
                                    [selectedValue]="selectedParcelID"
                                    (selectedValueChange)="onSelectedParcelIDChanged($event)">
                                    <div headerActions>
                                        <div class="navigation-selector-container">
                                            @if (currentUserGeographies.length > 1) {
                                                <div class="form-field navigation-selector mr-1">
                                                    <div class="field">
                                                        <ng-select
                                                            name="Geography"
                                                            [(ngModel)]="currentGeography"
                                                            (ngModelChange)="onGeographySelected($event)"
                                                            [compareWith]="compareGeography"
                                                            [items]="currentUserGeographies"
                                                            [clearable]="false"
                                                            [searchable]="false"
                                                            bindLabel="GeographyName"
                                                            class="custom small">
                                                        </ng-select>
                                                    </div>
                                                </div>
                                            }
                                            <div class="form-field navigation-selector">
                                                <div class="field">
                                                    <ng-select
                                                        name="ReportingPeriod"
                                                        [(ngModel)]="currentReportingPeriodID"
                                                        (ngModelChange)="onReportingPeriodSelected($event)"
                                                        [items]="reportingPeriods"
                                                        [clearable]="false"
                                                        [searchable]="false"
                                                        bindLabel="Name"
                                                        bindValue="ReportingPeriodID"
                                                        class="custom small">
                                                    </ng-select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    @if (mapIsReady) {
                                        <div mapLayers [loadingSpinner]="{ isLoading: layerLoading, opacity: 0.33 }">
                                            @if (parcelIDs$ | async; as parcelIDs) {
                                                <parcel-layer
                                                    [geographyID]="geography.GeographyID"
                                                    [reportingPeriodID]="currentReportingPeriodID"
                                                    [map]="map"
                                                    [layerControl]="layerControl"
                                                    [displayOnLoad]="true"
                                                    [selectedParcelID]="selectedParcelID"
                                                    [parcelIDs]="currentUserHasOverallPermission ? null : parcelIDs"
                                                    (parcelSelected)="onSelectedParcelIDChanged($event)"
                                                    (layerStartedLoading)="onLayerLoadStarted()"
                                                    (layerFinishedLoading)="onLayerLoadFinished()"></parcel-layer>
                                            }
                                            <gsa-boundaries
                                                [displayOnLoad]="false"
                                                [map]="map"
                                                [geographyID]="geography.GeographyID"
                                                [layerControl]="layerControl"></gsa-boundaries>
                                            @for (zoneGroup of zoneGroups$ | async; track zoneGroup) {
                                                <zone-group-layer
                                                    [displayOnLoad]="false"
                                                    [zoneGroupID]="zoneGroup.ZoneGroupID"
                                                    [zoneGroupName]="zoneGroup.ZoneGroupName"
                                                    [map]="map"
                                                    [layerControl]="layerControl">
                                                </zone-group-layer>
                                            }
                                            @for (externalMapLayer of externalMapLayers$ | async; track externalMapLayer) {
                                                <geography-external-map-layer [map]="map" [layerControl]="layerControl" [externalMapLayer]="externalMapLayer">
                                                </geography-external-map-layer>
                                            }
                                        </div>
                                    }
                                </hybrid-map-grid>
                            }
                        }
                    } @else {
                        <div class="alert alert-info">
                            <div class="alert-content">
                                <i class="fa fa-info"></i>
                                Your user profile does not currently have access to any Parcels. Claim Water Accounts to get started or contact a water manager for your geography
                                for assistance.
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    }
}
